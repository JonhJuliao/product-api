name: CI on Pull Requests

on:
  pull_request:
    branches: ["main"]

jobs:
  build-test-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (PR head)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Java 17 (Temurin) + cache Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 1) Baixar dependências (offline-ready)
      - name: Dependencies (go-offline)
        run: ./mvnw -B -q -DskipTests dependency:go-offline

      # 2) Compilar (sem testes)
      - name: Compile
        run: ./mvnw -B -q -DskipTests package

      # 3) Testes (gera coverage.exec)
      - name: Test
        run: ./mvnw -B test

      # 4) Cobertura (relatório + gate)
      - name: Coverage (JaCoCo report)
        run: ./mvnw -B -q jacoco:report

      - name: Coverage Gate (JaCoCo verify)
        run: ./mvnw -B -q jacoco:check

      # 5) Verificação de estilo (Spotless)
      - name: Style Check (Spotless)
        run: ./mvnw -B -q spotless:check
